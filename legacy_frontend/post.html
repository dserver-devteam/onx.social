<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ONX Social - View Post">
    <title>Post - ONX Social</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/index.css">
    <style>
        .post-detail {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--color-border);
        }

        .post-detail .post-text {
            font-size: var(--font-size-lg);
            line-height: 1.6;
            margin: var(--spacing-lg) 0;
        }

        .post-detail .post-time {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-md);
        }

        .post-stats {
            display: flex;
            gap: var(--spacing-xl);
            padding: var(--spacing-md) 0;
            border-top: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
            margin: var(--spacing-md) 0;
        }

        .post-stat {
            display: flex;
            gap: var(--spacing-xs);
            font-size: var(--font-size-sm);
        }

        .post-stat-value {
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .post-stat-label {
            color: var(--color-text-secondary);
        }

        .replies-section {
            border-top: 1px solid var(--color-border);
        }

        .replies-header {
            padding: var(--spacing-lg);
            font-weight: 700;
            font-size: var(--font-size-lg);
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-text-primary);
            text-decoration: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-md);
        }

        .back-button:hover {
            background: var(--color-bg-hover);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Left Sidebar - Navigation -->
        <aside class="sidebar">
            <div class="sidebar-content">
                <!-- Logo -->
                <div class="logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                        <circle cx="20" cy="20" r="18" stroke="currentColor" stroke-width="3" />
                        <path d="M15 20L18 23L25 16" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span class="logo-text">onx.social</span>
                </div>

                <!-- Navigation Menu -->
                <nav class="nav-menu">
                    <a href="/" class="nav-item">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span>Home</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="user-profile sidebar-profile">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=CurrentUser" alt="User"
                        class="user-avatar">
                    <div class="user-info">
                        <div class="user-name">You</div>
                        <div class="user-handle">@you</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Feed -->
        <main class="main-feed">
            <!-- Header -->
            <header class="feed-header">
                <a href="/" class="back-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Back
                </a>
                <h1>Post</h1>
            </header>

            <!-- Post Detail -->
            <div id="postDetail">
                <div class="loading">Loading post...</div>
            </div>

            <!-- Replies Section -->
            <div class="replies-section" id="repliesSection" style="display: none;">
                <div class="replies-header">Replies</div>
                <div id="repliesList"></div>
            </div>
        </main>

        <!-- Right Sidebar - Widgets -->
        <aside class="widgets">
            <!-- Search -->
            <div class="search-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" />
                    <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <input type="text" placeholder="Search ONX Social" class="search-input">
            </div>
        </aside>
    </div>

    <script>
        // API Base URL
        const API_BASE = '/api';

        // Current user
        let currentUser = null;

        // Get post ID from URL
        const postId = window.location.pathname.split('/post/')[1];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    currentUser = JSON.parse(userStr);
                    updateUserInfo();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }

            // Load post
            await loadPost();
        });

        function updateUserInfo() {
            if (currentUser) {
                document.querySelector('.user-name').textContent = currentUser.display_name;
                document.querySelector('.user-handle').textContent = `@${currentUser.username}`;
                document.querySelector('.user-avatar').src = currentUser.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.username}`;
            }
        }

        async function loadPost() {
            try {
                const userIdParam = currentUser ? `?user_id=${currentUser.id}` : '';
                const response = await fetch(`${API_BASE}/posts/${postId}${userIdParam}`);

                if (!response.ok) {
                    throw new Error('Post not found');
                }

                const post = await response.json();
                renderPost(post);

                // Load replies
                await loadReplies();
            } catch (error) {
                console.error('Error loading post:', error);
                document.getElementById('postDetail').innerHTML = `
                    <div class="loading" style="color: var(--color-like);">
                        Post not found or error loading post.
                    </div>
                `;
            }
        }

        function renderPost(post) {
            const postDate = new Date(post.created_at);
            const formattedDate = postDate.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });

            document.getElementById('postDetail').innerHTML = `
                <div class="post-detail">
                    <div class="post-header">
                        <img src="${post.avatar_url}" alt="${post.display_name}" class="post-avatar">
                        <div>
                            <div class="post-author">${post.display_name}</div>
                            <div class="post-username">@${post.username}</div>
                        </div>
                    </div>
                    <div class="post-text">${linkifyContent(post.content)}</div>
                    <div class="post-time">${formattedDate}</div>
                    <div class="post-stats">
                        <div class="post-stat">
                            <span class="post-stat-value">${post.repost_count || 0}</span>
                            <span class="post-stat-label">Reposts</span>
                        </div>
                        <div class="post-stat">
                            <span class="post-stat-value">${post.like_count || 0}</span>
                            <span class="post-stat-label">Likes</span>
                        </div>
                        <div class="post-stat">
                            <span class="post-stat-value">${post.reply_count || 0}</span>
                            <span class="post-stat-label">Replies</span>
                        </div>
                    </div>
                    <div class="post-actions">
                        <button class="action-btn" onclick="window.location.href='/'">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M21 11.5C21.0034 12.8199 20.6951 14.1219 20.1 15.3C19.3944 16.7118 18.3098 17.8992 16.9674 18.7293C15.6251 19.5594 14.0782 19.9994 12.5 20C11.1801 20.0035 9.87812 19.6951 8.7 19.1L3 21L4.9 15.3C4.30493 14.1219 3.99656 12.8199 4 11.5C4.00061 9.92179 4.44061 8.37488 5.27072 7.03258C6.10083 5.69028 7.28825 4.6056 8.7 3.90003C9.87812 3.30496 11.1801 2.99659 12.5 3.00003H13C15.0843 3.11502 17.053 3.99479 18.5291 5.47089C20.0052 6.94699 20.885 8.91568 21 11V11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="action-count">Reply</span>
                        </button>
                        <button class="action-btn ${post.user_reposted ? 'reposted' : ''}" onclick="toggleRepost(${post.id}, this)">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M17 1L21 5L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 11V9C3 7.93913 3.42143 6.92172 4.17157 6.17157C4.92172 5.42143 5.93913 5 7 5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 23L3 19L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M21 13V15C21 16.0609 20.5786 17.0783 19.8284 17.8284C19.0783 18.5786 18.0609 19 17 19H3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="action-count">${post.repost_count || 0}</span>
                        </button>
                        <button class="action-btn ${post.user_liked ? 'liked' : ''}" onclick="toggleLike(${post.id}, this)">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M20.84 4.61C20.3292 4.099 19.7228 3.69364 19.0554 3.41708C18.3879 3.14052 17.6725 2.99817 16.95 2.99817C16.2275 2.99817 15.5121 3.14052 14.8446 3.41708C14.1772 3.69364 13.5708 4.099 13.06 4.61L12 5.67L10.94 4.61C9.9083 3.57831 8.50903 2.99871 7.05 2.99871C5.59096 2.99871 4.19169 3.57831 3.16 4.61C2.1283 5.64169 1.54871 7.04097 1.54871 8.5C1.54871 9.95903 2.1283 11.3583 3.16 12.39L4.22 13.45L12 21.23L19.78 13.45L20.84 12.39C21.351 11.8792 21.7564 11.2728 22.0329 10.6053C22.3095 9.93789 22.4518 9.22248 22.4518 8.5C22.4518 7.77752 22.3095 7.06211 22.0329 6.39464C21.7564 5.72718 21.351 5.12075 20.84 4.61Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="action-count">${post.like_count || 0}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        async function loadReplies() {
            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/replies`);
                if (!response.ok) return;

                const replies = await response.json();

                if (replies.length > 0) {
                    document.getElementById('repliesSection').style.display = 'block';
                    document.getElementById('repliesList').innerHTML = replies.map(reply => createReplyHTML(reply)).join('');
                }
            } catch (error) {
                console.error('Error loading replies:', error);
            }
        }

        function createReplyHTML(reply) {
            const timeAgo = getTimeAgo(new Date(reply.created_at));
            return `
                <div class="post-card">
                    <img src="${reply.avatar_url}" alt="${reply.display_name}" class="post-avatar">
                    <div class="post-content">
                        <div class="post-header">
                            <span class="post-author">${reply.display_name}</span>
                            <span class="post-username">@${reply.username}</span>
                            <span class="post-time">Â· ${timeAgo}</span>
                        </div>
                        <div class="post-text">${linkifyContent(reply.content)}</div>
                    </div>
                </div>
            `;
        }

        function linkifyContent(text) {
            const div = document.createElement('div');
            div.textContent = text;
            let escaped = div.innerHTML;

            escaped = escaped.replace(/@(\w+)/g, '<a href="#" class="mention" data-username="$1" onclick="navigateToUserProfile(event, \'$1\')">@$1</a>');
            escaped = escaped.replace(/#(\w+)/g, '<a href="#" class="hashtag" data-tag="$1" onclick="navigateToHashtag(event, \'$1\')">#$1</a>');

            return escaped;
        }

        function navigateToUserProfile(event, username) {
            event.preventDefault();
            window.location.href = `/?user=${username}`;
        }

        function navigateToHashtag(event, tag) {
            event.preventDefault();
            window.location.href = `/?hashtag=${tag}`;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };

            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval}${unit.charAt(0)}`;
                }
            }
            return 'now';
        }

        async function toggleLike(postId, button) {
            if (!currentUser) {
                alert('Please log in to like posts');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });

                if (!response.ok) throw new Error('Failed to toggle like');
                const data = await response.json();

                const countSpan = button.querySelector('.action-count');
                let currentCount = parseInt(countSpan.textContent) || 0;

                if (data.liked) {
                    button.classList.add('liked');
                    countSpan.textContent = currentCount + 1;
                } else {
                    button.classList.remove('liked');
                    countSpan.textContent = Math.max(0, currentCount - 1);
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        async function toggleRepost(postId, button) {
            if (!currentUser) {
                alert('Please log in to repost');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/posts/${postId}/repost`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });

                if (!response.ok) throw new Error('Failed to toggle repost');
                const data = await response.json();

                const countSpan = button.querySelector('.action-count');
                let currentCount = parseInt(countSpan.textContent) || 0;

                if (data.reposted) {
                    button.classList.add('reposted');
                    countSpan.textContent = currentCount + 1;
                } else {
                    button.classList.remove('reposted');
                    countSpan.textContent = Math.max(0, currentCount - 1);
                }
            } catch (error) {
                console.error('Error toggling repost:', error);
            }
        }
    </script>
</body>

</html>